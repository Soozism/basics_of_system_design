# مفهوم Failover و Fallback در طراحی سیستم

این سند به بررسی مفاهیم **Failover** و **Fallback** در طراحی سیستم‌های توزیع‌شده و مقیاس‌پذیر می‌پردازد. هدف این است که با ارائه تعاریف، انواع، مکانیزم‌ها، مقایسه، سناریوهای واقعی و بهترین روش‌ها، یک راهنمای جامع و آموزشی برای یادگیری اصول طراحی سیستم فراهم شود. این محتوا به زبان فارسی و با فرمت مارک‌داون ارائه شده است تا برای مستندسازی آموزشی مناسب باشد.

---

## تعریف Failover

### Failover چیست و چرا مهم است؟
**Failover** (انتقال به حالت اضطراری) فرآیندی است که در آن سیستم در صورت خرابی یک جزء (مانند سرور، پایگاه داده یا سرویس) به‌طور خودکار یا دستی به یک جزء جایگزین (مانند سرور پشتیبان) سوئیچ می‌کند تا خدمات بدون وقفه ادامه یابند. هدف Failover، تضمین **دسترس‌پذیری بالا (High Availability)** و **تحمل‌پذیری خطا (Fault Tolerance)** است.

**چرا مهم است؟**
- **کاهش قطعی سرویس:** در سیستم‌های حیاتی (مانند تجارت الکترونیک یا بانکداری)، حتی چند دقیقه قطعی می‌تواند خسارات مالی و اعتباری به همراه داشته باشد.
- **تجربه کاربری:** Failover از اختلال در تجربه کاربران جلوگیری می‌کند.
- **قابلیت اطمینان:** تضمین می‌کند که سیستم در برابر خرابی‌های سخت‌افزاری، نرم‌افزاری یا شبکه‌ای مقاوم است.
- **مثال:** اگر سرور اصلی یک وب‌سایت تجارت الکترونیک خراب شود، Failover ترافیک را به سرور پشتیبان هدایت می‌کند.

### انواع Failover
1. **Failover خودکار (Automatic Failover):**
   - **توضیح:** سیستم به‌طور خودکار خرابی را تشخیص داده و به جزء جایگزین سوئیچ می‌کند بدون نیاز به دخالت انسانی.
   - **مزایا:** سرعت بالا و کاهش زمان قطعی.
   - **معایب:** نیاز به تنظیمات پیچیده و ابزارهای پیشرفته.
   - **مثال:** در Kubernetes، اگر یک پاد (Pod) خراب شود، ReplicaSet به‌طور خودکار پاد جدیدی ایجاد می‌کند.
2. **Failover دستی (Manual Failover):**
   - **توضیح:** نیاز به دخالت انسانی برای شناسایی خرابی و انتقال به جزء جایگزین دارد.
   - **مزایا:** کنترل بیشتر و مناسب برای سیستم‌های کمتر حیاتی.
   - **معایب:** زمان‌بر و مستعد خطای انسانی.
   - **مثال:** مدیر سیستم به‌صورت دستی ترافیک را از یک سرور معیوب به سرور پشتیبان هدایت می‌کند.

### مکانیزم‌های رایج Failover
1. **متعادل‌سازهای بار (Load Balancers):**
   - ابزارهایی مانند AWS ELB یا NGINX بررسی‌های سلامت (Health Checks) را انجام می‌دهند و ترافیک را به سرورهای سالم هدایت می‌کنند.
   - **مثال:** AWS ELB در صورت خرابی یک نمونه EC2، ترافیک را به نمونه‌های دیگر هدایت می‌کند.
2. **سرورهای پشتیبان (Backup Servers):**
   - سرورهای آماده به کار (Standby) که در حالت غیرفعال هستند تا در صورت خرابی فعال شوند.
   - **مثال:** سرورهای Hot Standby در پایگاه داده‌های PostgreSQL.
3. **خدمات خوشه‌ای (Clustered Services):**
   - استفاده از خوشه‌هایی که چندین گره دارند و در صورت خرابی یکی، گره‌های دیگر وظایف را بر عهده می‌گیرند.
   - **مثال:** خوشه‌های Apache Kafka برای مدیریت پیام‌ها در صورت خرابی یک گره.

### مثال‌ها
- **Failover پایگاه داده:** در Amazon RDS، اگر گره اصلی (Master) خراب شود، Failover خودکار به گره پشتیبان (Read Replica) در منطقه دسترسی دیگر انجام می‌شود.
- **Failover سرویس در Kubernetes:** اگر یک پاد در یک سرویس میکروسرویس خراب شود، Kubernetes به‌طور خودکار پاد جدیدی ایجاد کرده و ترافیک را به آن هدایت می‌کند.
- **Failover شبکه:** استفاده از چندین ارائه‌دهنده CDN (مانند Cloudflare و Akamai) برای هدایت ترافیک در صورت خرابی یک مسیر شبکه‌ای.

---

## تعریف Fallback

### Fallback چیست و چگونه با Failover متفاوت است؟
**Fallback** (بازگشت به حالت جایگزین) به معنای ارائه یک راه‌حل جایگزین یا حالت کاهش‌یافته (Degraded Mode) برای حفظ عملکرد سیستم در هنگام خرابی است، بدون اینکه لزوماً به یک جزء کاملاً جایگزین سوئیچ شود. برخلاف Failover که به یک سیستم یا سرور دیگر منتقل می‌شود، Fallback معمولاً شامل استفاده از داده‌های کش‌شده، پاسخ‌های پیش‌فرض یا حالت‌های ساده‌تر است.

**تفاوت با Failover:**
- **Failover:** انتقال کامل به یک سیستم یا سرور جایگزین (مانند سرور پشتیبان).
- **Fallback:** ارائه پاسخ محدود یا جایگزین بدون تغییر سیستم اصلی.
- **مثال:** اگر API اصلی از کار بیفتد، Failover به یک سرور دیگر سوئیچ می‌کند، در حالی که Fallback ممکن است داده‌های کش‌شده را بازگرداند.

### موارد استفاده Fallback
1. **استفاده از داده‌های کش‌شده:**
   - اگر سرویس اصلی در دسترس نباشد، سیستم از داده‌های ذخیره‌شده در کش (مانند Redis) استفاده می‌کند.
   - **مثال:** یک وب‌سایت خبری داده‌های کش‌شده مقالات را نمایش می‌دهد اگر سرور اصلی پاسخ ندهد.
2. **حالت کاهش‌یافته (Degraded Mode):**
   - ارائه عملکرد محدود به جای قطعی کامل سرویس.
   - **مثال:** در یک اپلیکیشن پخش ویدئو، اگر سرور توصیه ویدئو خراب شود، سیستم ویدئوهای پرطرفدار را نمایش می‌دهد.
3. **پاسخ‌های پیش‌فرض:**
   - ارائه پاسخ‌های ثابت یا پیش‌فرض در صورت خرابی.
   - **مثال:** در یک اپلیکیشن پرداخت، اگر سرویس تأیید پرداخت خراب شود، سیستم پیام "لطفاً بعداً تلاش کنید" را نمایش می‌دهد.

### مزایا در بهبود تجربه کاربری
- **جلوگیری از قطعی کامل:** کاربران به جای خطا، یک پاسخ جایگزین دریافت می‌کنند.
- **تجربه کاربری بهتر:** حالت‌های کاهش‌یافته یا داده‌های کش‌شده تجربه‌ای روان‌تر ارائه می‌دهند.
- **کاهش فشار بر سیستم:** Fallback می‌تواند بار روی سیستم را کاهش دهد تا زمان بازیابی.
- **مثال:** نتفلیکس در صورت خرابی سرویس توصیه، لیست ویدئوهای پرطرفدار را نمایش می‌دهد تا کاربران همچنان بتوانند محتوا تماشا کنند.

---

## مقایسه بین Failover و Fallback

| **معیار**                | **Failover**                              | **Fallback**                              |
|--------------------------|------------------------------------------|------------------------------------------|
| **تعریف**               | انتقال به یک سیستم یا سرور جایگزین      | ارائه پاسخ جایگزین یا حالت کاهش‌یافته   |
| **هدف**                 | حفظ دسترس‌پذیری کامل                   | حفظ عملکرد محدود و جلوگیری از خطا        |
| **پیچیدگی**            | پیچیده‌تر، نیاز به اجزای اضافی         | ساده‌تر، استفاده از داده‌های موجود       |
| **مکانیزم‌ها**          | متعادل‌سازهای بار، سرورهای پشتیبان     | کش، پاسخ‌های پیش‌فرض، حالت کاهش‌یافته  |
| **زمان پاسخ**           | سریع، اما ممکن است تأخیر داشته باشد     | بسیار سریع، بدون نیاز به سوئیچ         |
| **مثال**                | انتقال به سرور پشتیبان در AWS          | نمایش داده‌های کش‌شده از Redis          |

**تفاوت کلیدی:** Failover بر انتقال کامل به یک سیستم جایگزین تمرکز دارد، در حالی که Fallback بر ارائه پاسخ‌های محدود یا جایگزین برای حفظ تجربه کاربری تمرکز می‌کند.

---

## سناریوهای واقعی

1. **سناریوی Failover (آمازون - تجارت الکترونیک):**
   - **وضعیت:** سرور اصلی پایگاه داده (Amazon RDS) در یک منطقه دسترسی (us-east-1) خراب می‌شود.
   - **Failover:** AWS RDS به‌طور خودکار به گره پشتیبان در منطقه دسترسی دیگر (us-east-2) سوئیچ می‌کند. ترافیک کاربران بدون وقفه به گره جدید هدایت می‌شود.
   - **نتیجه:** کاربران بدون متوجه شدن خرابی، به خرید ادامه می‌دهند.

2. **سناریوی Fallback (نتفلیکس - پخش ویدئو):**
   - **وضعیت:** سرویس توصیه ویدئو نتفلیکس به دلیل بار زیاد از کار می‌افتد.
   - **Fallback:** سیستم به حالت کاهش‌یافته سوئیچ کرده و لیست ویدئوهای پرطرفدار را از Redis نمایش می‌دهد.
   - **نتیجه:** کاربران همچنان می‌توانند ویدئو تماشا کنند، هرچند توصیه‌های شخصی‌سازی‌شده در دسترس نیست.

3. **ترکیب Failover و Fallback (گوگل - موتور جستجو):**
   - **وضعیت:** یکی از سرورهای Google Search در یک مرکز داده خراب می‌شود.
   - **Failover:** ترافیک به سرورهای دیگر در مرکز داده‌های دیگر هدایت می‌شود.
   - **Fallback:** اگر پاسخ‌ها به‌موقع دریافت نشوند، نتایج کش‌شده از جستجوهای قبلی نمایش داده می‌شوند.
   - **نتیجه:** کاربران نتایج جستجو را بدون تأخیر دریافت می‌کنند.

---

## بهترین روش‌ها برای طراحی سیستم‌های مقاوم با Failover و Fallback

1. **پیاده‌سازی Failover خودکار:**
   - از ابزارهایی مانند AWS ELB، Kubernetes یا Apache ZooKeeper برای تشخیص خودکار خرابی‌ها و انتقال به اجزای جایگزین استفاده کنید.
   - بررسی‌های سلامت (Health Checks) را با بازه‌های کوتاه (مانند ۵ ثانیه) تنظیم کنید.
   - **مثال:** تنظیم Health Checks در AWS ELB برای حذف نمونه‌های EC2 معیوب.

2. **طراحی Fallback‌های هوشمند:**
   - داده‌های مهم را در کش (مانند Redis یا Memcached) ذخیره کنید تا در صورت خرابی استفاده شوند.
   - حالت‌های کاهش‌یافته را برای حفظ تجربه کاربری طراحی کنید (مانند نمایش محتوای عمومی به جای محتوای شخصی‌سازی‌شده).
   - **مثال:** استفاده از Redis برای ذخیره داده‌های کش‌شده در یک وب‌سایت خبری.

3. **مانیتورینگ جامع:**
   - از ابزارهایی مانند Prometheus، Grafana یا CloudWatch برای رصد خرابی‌ها و معیارهای کلیدی (مانند تأخیر و نرخ خطا) استفاده کنید.
   - هشدارهای خودکار برای اطلاع‌رسانی به تیم‌های عملیاتی تنظیم کنید.
   - **مثال:** تنظیم هشدار در CloudWatch برای اطلاع از خرابی سرورها.

4. **تست خرابی‌ها:**
   - از تکنیک‌های Chaos Engineering (مانند Netflix Chaos Monkey) برای شبیه‌سازی خرابی‌ها و تست Failover و Fallback استفاده کنید.
   - **مثال:** غیرفعال کردن تصادفی سرورها در یک محیط تست برای بررسی رفتار سیستم.

5. **بهینه‌سازی هزینه‌ها:**
   - از منابع پشتیبان به‌صورت پویا (مانند Auto Scaling در AWS) استفاده کنید تا هزینه‌ها کاهش یابد.
   - برای Fallback، داده‌های کش‌شده را بهینه کنید تا مصرف حافظه کاهش یابد.
   - **مثال:** استفاده از نمونه‌های Spot در AWS برای سرورهای پشتیبان.

6. **امنیت:**
   - ارتباطات بین گره‌های Failover را با TLS رمزنگاری کنید.
   - دسترسی‌ها را با RBAC (Role-Based Access Control) محدود کنید.
   - **مثال:** استفاده از AWS KMS برای رمزنگاری داده‌های کش‌شده.

7. **ترکیب Failover و Fallback:**
   - از Failover برای سیستم‌های حیاتی و Fallback برای بهبود تجربه کاربری در شرایط غیرحیاتی استفاده کنید.
   - **مثال:** در یک اپلیکیشن پرداخت، Failover به سرور پشتیبان برای پردازش تراکنش‌ها و Fallback به پیام خطا برای کاربران در صورت خرابی کامل.

---

## خلاصه و نکات کلیدی

### خلاصه
- **Failover:** انتقال به سیستم یا سرور جایگزین برای حفظ دسترس‌پذیری کامل در صورت خرابی.
- **Fallback:** ارائه پاسخ‌های جایگزین یا حالت کاهش‌یافته برای حفظ عملکرد محدود.
- **مقایسه:** Failover بر سوئیچ به اجزای جایگزین تمرکز دارد، در حالی که Fallback بر پاسخ‌های محدود برای بهبود تجربه کاربری تمرکز می‌کند.
- **مثال‌های واقعی:** آمازون از Failover در RDS و نتفلیکس از Fallback برای نمایش محتوای کش‌شده استفاده می‌کنند.
- **درس کلیدی:** ترکیب Failover و Fallback برای طراحی سیستم‌های مقاوم و کاربرپسند ضروری است.

### نکات کلیدی برای مهندسان
1. **اتوماسیون Failover:** از ابزارهای خودکار مانند Kubernetes و AWS ELB برای کاهش زمان قطعی استفاده کنید.
2. **Fallback هوشمند:** داده‌های کش‌شده و حالت‌های کاهش‌یافته را برای بهبود تجربه کاربری پیاده‌سازی کنید.
3. **مانیتورینگ و تست:** خرابی‌ها را شبیه‌سازی کرده و معیارهای کلیدی را رصد کنید.
4. **بهینه‌سازی منابع:** از Auto Scaling و منابع پویا برای کاهش هزینه‌ها استفاده کنید.
5. **امنیت:** ارتباطات و داده‌های کش‌شده را رمزنگاری کنید.

---

## منابع پیشنهادی برای مطالعه بیشتر
1. *Designing Data-Intensive Applications* نوشته Martin Kleppmann: کتابی جامع برای یادگیری سیستم‌های توزیع‌شده.
2. *Site Reliability Engineering* نوشته Google: راهنمایی برای طراحی سیستم‌های قابل‌اعتماد.
3. وبلاگ‌های مهندسی:
   - *AWS Architecture Blog*: مقالات در مورد Failover در AWS.
   - *Netflix Tech Blog*: توضیحات در مورد Chaos Engineering و Fallback.
4. مستندات رسمی:
   - [AWS ELB Documentation](https://docs.aws.amazon.com/elasticloadbalancing/)
   - [Kubernetes Documentation](https://kubernetes.io/docs/)
   - [Redis Documentation](https://redis.io/documentation)
5. دوره‌های آنلاین:
   - *Grokking the System Design Interview* در DesignGuru.io
   - *Site Reliability Engineering* در Coursera

---

این سند مفاهیم Failover و Fallback را به‌صورت جامع توضیح داده و برای مهندسان علاقه‌مند به طراحی سیستم‌های مقیاس‌پذیر و مقاوم مناسب است. در صورت نیاز به جزئیات بیشتر یا مثال‌های دیگر، لطفاً اطلاع دهید!