# قضیه CAP و مدل PACELC در سیستم‌های توزیع‌شده

## مقدمه‌ای بر قضیه CAP

**قضیه CAP** (Consistency, Availability, Partition Tolerance) بیان می‌کند که در یک سیستم توزیع‌شده، تنها می‌توان دو مورد از سه ویژگی زیر را به‌طور همزمان تضمین کرد:
- **سازگاری (Consistency)**: همه گره‌ها در هر لحظه داده‌های یکسانی از داده‌ها را مشاهده می‌کنند. به عبارت دیگر، هر خواندن از سیستم باید آخرین نسخه داده را برگرداند.
- **دسترسی‌پذیری (Availability)**: هر درخواست (خواندن یا نوشتن) به سیستم باید پاسخ معتبر دریافت کند، حتی اگر برخی گره‌ها از کار افتاده باشند.
- **تحمل پارتیشن‌بندی (Partition Tolerance)**: سیستم حتی در صورت قطع ارتباط بین گره‌ها (پارتیشن‌بندی شبکه) به کار خود ادامه می‌دهد.

### چرا تنها دو ویژگی قابل تضمین است؟
در سیستم‌های توزیع‌شده، پارتیشن‌بندی شبکه (مانند قطعی ارتباط بین گره‌ها) اجتناب‌ناپذیر است. وقتی پارتیشن‌بندی رخ می‌دهد، سیستم باید بین **سازگاری** و **دسترسی‌پذیری** یکی را انتخاب کند:
- اگر **سازگاری** در اولویت باشد، سیستم ممکن است درخواست‌ها را رد کند تا از ارائه داده‌های ناسازگار جلوگیری شود (سیستم‌های CP).
- اگر **دسترسی‌پذیری** در اولویت باشد، سیستم به هر درخواست پاسخ می‌دهد، حتی اگر داده‌ها ناسازگار باشند (سیستم‌های AP).
- تحمل پارتیشن‌بندی به دلیل ماهیت شبکه‌های توزیع‌شده معمولاً غیرقابل اجتناب است، بنابراین سیستم‌ها باید بین C و A انتخاب کنند.

### مثال‌هایی از سیستم‌ها در طیف CAP
- **سیستم‌های CP (سازگاری + تحمل پارتیشن‌بندی)**:
  - **Google Spanner**: با استفاده از TrueTime، سازگاری قوی را حتی در سیستم‌های توزیع‌شده جهانی ارائه می‌دهد، اما ممکن است در زمان پارتیشن‌بندی دسترسی‌پذیری را محدود کند.
  - **HBase**: اولویت به سازگاری قوی می‌دهد و در صورت پارتیشن‌بندی ممکن است درخواست‌ها را رد کند.
- **سیستم‌های AP (دسترسی‌پذیری + تحمل پارتیشن‌بندی)**:
  - **Apache Cassandra**: سازگاری نهایی را ارائه می‌دهد و دسترسی‌پذیری را در اولویت قرار می‌دهد، حتی در شرایط پارتیشن‌بندی.
  - **Amazon DynamoDB**: با تنظیمات پیش‌فرض، دسترسی‌پذیری و سازگاری نهایی را ترجیح می‌دهد.
- **سیستم‌های CA**: این سیستم‌ها در عمل نادر هستند، زیرا پارتیشن‌بندی شبکه در سیستم‌های توزیع‌شده واقعی اجتناب‌ناپذیر است. با این حال، پایگاه‌های داده تک‌نود (مانند MySQL سنتی) می‌توانند CA باشند، اما توزیع‌شده نیستند.

---

## معرفی مدل PACELC

**مدل PACELC** (مخفف Partition, Availability, Consistency, Else, Latency, Consistency) قضیه CAP را گسترش می‌دهد و جنبه‌های عملیاتی بیشتری را در نظر می‌گیرد. این مدل بیان می‌کند که:
- در صورت **پارتیشن‌بندی (P)**، سیستم باید بین **سازگاری (C)** و **دسترسی‌پذیری (A)** انتخاب کند (مشابه CAP).
- در حالت **عادی (Else)**، یعنی زمانی که پارتیشن‌بندی وجود ندارد، سیستم باید بین **سازگاری (C)** و **تأخیر (Latency - L)** انتخاب کند.

### چگونه PACELC دید دقیق‌تری ارائه می‌دهد؟
قضیه CAP تنها به شرایط پارتیشن‌بندی شبکه تمرکز دارد، اما PACELC به عملکرد سیستم در حالت عادی نیز توجه می‌کند. در دنیای واقعی، حتی بدون پارتیشن‌بندی، سیستم‌ها باید بین کاهش تأخیر (برای پاسخ‌دهی سریع‌تر) و حفظ سازگاری قوی (برای داده‌های دقیق‌تر) تعادل برقرار کنند.

- **سیستم‌های PC/EC**: در زمان پارتیشن‌بندی، سازگاری را انتخاب می‌کنند (PC) و در حالت عادی نیز سازگاری را به تأخیر ترجیح می‌دهند (EC). مثال: HBase، Spanner.
- **سیستم‌های PA/EL**: در زمان پارتیشن‌بندی، دسترسی‌پذیری را انتخاب می‌کنند (PA) و در حالت عادی تأخیر کم را به سازگاری ترجیح می‌دهند (EL). مثال: Cassandra، DynamoDB.
- **سیستم‌های PA/EC**: در زمان پارتیشن‌بندی، دسترسی‌پذیری را انتخاب می‌کنند (PA)، اما در حالت عادی سازگاری را به تأخیر ترجیح می‌دهند. مثال: برخی تنظیمات MongoDB.
- **سیستم‌های PC/EL**: در زمان پارتیشن‌بندی، سازگاری را انتخاب می‌کنند (PC)، اما در حالت عادی تأخیر کم را ترجیح می‌دهند (EL). این حالت کمتر رایج است.

---

## پیامدهای عملی برای معماران سیستم

### نحوه تصمیم‌گیری درباره تعادل‌ها
انتخاب بین سازگاری، دسترسی‌پذیری و تأخیر به نیازهای خاص برنامه بستگی دارد:
- **برنامه‌های مالی (مانند بانکداری)**: نیاز به سازگاری قوی دارند (PC/EC). تأخیر بالاتر قابل قبول است، اما داده‌های ناسازگار می‌توانند فاجعه‌بار باشند.
- **شبکه‌های اجتماعی یا سیستم‌های محتوایی**: دسترسی‌پذیری و تأخیر کم (PA/EL) در اولویت هستند، زیرا کاربران انتظار پاسخ سریع دارند و ناسازگاری موقت قابل تحمل است.
- **برنامه‌های بلادرنگ (مانند سیستم‌های IoT)**: تأخیر کم حیاتی است، حتی اگر به قیمت سازگاری تمام شود (PA/EL یا PC/EL).
- **برنامه‌های تحلیل داده**: ممکن است به سازگاری نهایی اکتفا کنند، اما نیاز به دسترسی‌پذیری بالا دارند (PA/EL).

### نمونه‌های واقعی پایگاه‌های داده در طیف CAP و PACELC
1. **Apache Cassandra**:
   - **CAP**: PA (دسترسی‌پذیری + تحمل پارتیشن‌بندی). Cassandra سازگاری نهایی را ارائه می‌دهد و در زمان پارتیشن‌بندی دسترسی‌پذیری را حفظ می‌کند.
   - **PACELC**: PA/EL. در حالت عادی، Cassandra تأخیر کم را با تنظیمات سطح سازگاری (مانند QUORUM یا ONE) اولویت‌بندی می‌کند.
   - **کاربرد**: مناسب برای برنامه‌هایی مانند شبکه‌های اجتماعی یا سیستم‌های توصیه‌گر که نیاز به دسترسی‌پذیری بالا و تأخیر کم دارند.

2. **Amazon DynamoDB**:
   - **CAP**: PA. DynamoDB به‌صورت پیش‌فرض سازگاری نهایی را ارائه می‌دهد، اما با تنظیمات خاص می‌تواند سازگاری قوی‌تری فراهم کند.
   - **PACELC**: PA/EL. در حالت عادی، DynamoDB تأخیر کم را برای پاسخ‌دهی سریع به کاربران ترجیح می‌دهد.
   - **کاربرد**: مناسب برای برنامه‌های تجارت الکترونیک و سیستم‌های مقیاس‌پذیر با ترافیک بالا.

3. **Apache HBase**:
   - **CAP**: CP. HBase سازگاری قوی را در اولویت قرار می‌دهد و در زمان پارتیشن‌بندی ممکن است دسترسی‌پذیری را محدود کند.
   - **PACELC**: PC/EC. در حالت عادی، HBase سازگاری را به تأخیر ترجیح می‌دهد، که برای برنامه‌های تحلیلی مناسب است.
   - **کاربرد**: مناسب برای برنامه‌هایی که نیاز به سازگاری قوی دارند، مانند سیستم‌های تحلیل داده‌های بزرگ.

---

## بهترین روش‌ها برای مدیریت تعادل‌ها

1. **درک نیازهای برنامه**:
   - قبل از طراحی سیستم، نیازهای خاص (مانند سازگاری، دسترسی‌پذیری یا تأخیر) را مشخص کنید.
   - با کاربران و ذینفعان مشورت کنید تا اولویت‌ها روشن شود.

2. **تنظیم سطح سازگاری**:
   - از سیستم‌هایی مانند Cassandra یا DynamoDB که امکان تنظیم سطح سازگاری (مانند QUORUM یا ONE) را فراهم می‌کنند، استفاده کنید.
   - برای مثال، در Cassandra می‌توانید سطح سازگاری را برای هر عملیات خواندن یا نوشتن تنظیم کنید.

3. **استفاده از الگوریتم‌های اجماع**:
   - برای سیستم‌های CP، از الگوریتم‌های اجماع مانند Paxos یا Raft (مانند آنچه در Spanner یا etcd استفاده می‌شود) بهره ببرید.
   - این الگوریتم‌ها به حفظ سازگاری در محیط‌های توزیع‌شده کمک می‌کنند.

4. **مانیتورینگ و آزمایش**:
   - از ابزارهای مانیتورینگ مانند Prometheus و Grafana برای شناسایی پارتیشن‌بندی یا مشکلات تأخیر استفاده کنید.
   - با استفاده از Chaos Engineering (مانند Chaos Monkey)، سیستم را در برابر پارتیشن‌بندی و خرابی‌ها آزمایش کنید.

5. **طراحی برای مقیاس‌پذیری**:
   - از پارتیشن‌بندی داده‌ها (مانند Sharding در MongoDB یا Cassandra) برای توزیع بار استفاده کنید.
   - اطمینان حاصل کنید که پارتیشن‌بندی به‌گونه‌ای است که تعادل بار حفظ شود.

---

## خلاصه و نکات کلیدی

- **قضیه CAP** نشان می‌دهد که در سیستم‌های توزیع‌شده، تنها دو ویژگی از سه ویژگی سازگاری، دسترسی‌پذیری و تحمل پارتیشن‌بندی قابل دستیابی است. این قضیه به معماران کمک می‌کند تا تصمیمات آگاهانه‌ای درباره طراحی سیستم بگیرند.
- **مدل PACELC** دید جامع‌تری ارائه می‌دهد و نشان می‌دهد که حتی در حالت عادی، سیستم‌ها باید بین سازگاری و تأخیر تعادل برقرار کنند.
- **انتخاب‌های طراحی** به نیازهای برنامه بستگی دارد. سیستم‌هایی مانند Cassandra و DynamoDB برای دسترسی‌پذیری و تأخیر کم بهینه شده‌اند (PA/EL)، در حالی که HBase و Spanner سازگاری قوی را اولویت‌بندی می‌کنند (PC/EC).
- **مهندسان نرم‌افزار** باید نیازهای برنامه را به‌دقت تحلیل کنند، از ابزارهای مناسب (مانند الگوریتم‌های اجماع و مانیتورینگ) استفاده کنند و سیستم را به‌طور مداوم آزمایش کنند تا از عملکرد مطلوب اطمینان حاصل کنند.

با درک عمیق CAP و PACELC، مهندسان می‌توانند سیستم‌های توزیع‌شده‌ای طراحی کنند که هم مقیاس‌پذیر و هم مقاوم در برابر خرابی باشند، در حالی که نیازهای خاص برنامه را برآورده می‌کنند.